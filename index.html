<!DOCTYPE html>
<html>

<head>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection" />
    <link type="text/css" rel="stylesheet" href="css/main.css" />

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Morse</title>
</head>

<body>
    <div id="app">
        <h2 class="center">
            Morse
        
            <div class="switch">
                <label>
                    400 Hz
                    
                    <input type="checkbox" v-model="high_pitch">
                    <span class="lever"></span>
                    
                    1020 Hz
                </label>
            </div>
        </h2>
    
        <div class="row" v-if="!started">
            <div class="col offset-l3 l6 offset-m2 m8 offset-s0 s12">
                <div class="center" v-if="!practice_status">
                    <a class="waves-effect waves-light btn btn-large blue darken-2" @click="startApp">Start</a>
                </div>
                
                <br /><br />
            </div>
        </div>
    
        <div class="row" v-if="started">
    
            <div class="col offset-l3 l6 offset-m2 m8 offset-s0 s12">
                <ul class="collapsible">
                    <li>
                        <div class="collapsible-header"><i class="material-icons">text_format</i>Individual letters</div>
                        <div class="collapsible-body">
                            <a class="play btn blue darken-2 waves-effect waves-blue">A</a>
    
                            <a class="play btn blue darken-2 waves-effect waves-blue">B</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">C</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">D</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">E</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">F</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">G</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">H</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">I</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">J</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">K</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">L</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">M</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">N</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">O</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">P</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">Q</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">R</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">S</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">T</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">U</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">V</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">W</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">X</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">Y</a>
                
                            <a class="play btn blue darken-2 waves-effect waves-blue">Z</a>
                        </div>
                    </li>
                    <li>
                        <div class="collapsible-header"><i class="material-icons">timer</i>Practice</div>
                        <div class="collapsible-body">
                            
                            <a class="waves-effect waves-light btn btn-small red darken-2 right" @click="pausePractice" v-if="practice_status == 'running'">Stop</a>
                            <a class="waves-effect waves-light btn btn-small green darken-2 right" @click="resumePractice" v-if="practice_status == 'paused'">Resume</a>
                            
                            <h5>Practice</h5>
                            
                            <div class="row">
                                <div class="switch">
                                    <label>
                                        Show Answers
                                        <input type="checkbox" v-model="show_answers">
                                        <span class="lever"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="center" v-if="!practice_status">
                                <a class="waves-effect waves-light btn btn-large blue darken-2" @click="startPractice">Start</a>
                            </div>
                            
                            <h4 v-if="practice_status == 'starting'" class="center">
                                {{ countdown }}...
                            </h4>
                            
                            <div v-if="practice_status == 'running' || practice_status == 'paused'">
                                <a class="word waves-effect waves-light btn btn-large blue darken-2" v-for="word in practice_words" @click="playText(word)">
                                    <template v-if="show_answers">{{ word }}</template>
                                    <template v-else>?</template>
                                </a>
                            </div>
                            
                        </div>
                    </li>
                    <li>
                        <div class="collapsible-header"><i class="material-icons">compare_arrows</i>Convert raw text</div>
                        <div class="collapsible-body">
                            
                            <div class="input-field">
                                <textarea id="raw-text" class="materialize-textarea blue-text text-darken-2"></textarea>
                                <label for="raw-text">Raw text</label>
                            </div>
                            
                            <a class="waves-effect waves-light btn blue darken-2" id="play-raw">Play in morse</a>
                            
                        </div>
                    </li>
                </ul>
                
                <!--<h5>Individual letters</h5>

                <a class="play btn blue darken-2 waves-effect waves-blue">A</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">B</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">C</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">D</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">E</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">F</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">G</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">H</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">I</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">J</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">K</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">L</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">M</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">N</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">O</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">P</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">Q</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">R</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">S</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">T</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">U</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">V</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">W</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">X</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">Y</a>
    
                <a class="play btn blue darken-2 waves-effect waves-blue">Z</a>

                <a class="waves-effect waves-light btn btn-small red darken-2 right" @click="pausePractice" v-if="practice_status == 'running'">Stop</a>
                <a class="waves-effect waves-light btn btn-small green darken-2 right" @click="resumePractice" v-if="practice_status == 'paused'">Resume</a>
                
                <h5>Practice</h5>
                
                <div class="row">
                    <div class="switch">
                        <label>
                            Show Answers
                            <input type="checkbox" v-model="show_answers">
                            <span class="lever"></span>
                        </label>
                    </div>
                </div>
                
                <div class="center" v-if="!practice_status">
                    <a class="waves-effect waves-light btn btn-large blue darken-2" @click="startPractice">Start</a>
                </div>
                
                <h4 v-if="practice_status == 'starting'" class="center">
                    {{ countdown }}...
                </h4>
                
                <div v-if="practice_status == 'running' || practice_status == 'paused'">
                    <a class="word waves-effect waves-light btn btn-large blue darken-2" v-for="word in practice_words" @click="playText(word)">
                        <template v-if="show_answers">{{ word }}</template>
                        <template v-else>?</template>
                    </a>
                </div>

                <h5>Convert raw text</h5>
    
                <div class="input-field">
                    <textarea id="raw-text" class="materialize-textarea blue-text text-darken-2"></textarea>
                    <label for="raw-text">Raw text</label>
    
                    <a class="waves-effect waves-light btn blue darken-2 right" id="play-raw">Play in morse</a>
                </div>-->
            </div>
        </div>
    
        <!-- Footer -->
        <footer class="ftr grey darken-3">
            <div class="footer-copyright">
                <div class="container tx">
                    &copy; Jesse &amp; Sam
                    <span class="right">For students of the KLM Flight Academy</span>
                </div>
            </div>
        </footer>
    </div>  

    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="js/materialize.min.js"></script>

    <script src="js/vue.js"></script>
    <script src="js/morse.js"></script>

    <script>
        var BUFFERS = {}

        loadSound('low.wav', function(s) {
            BUFFERS['low'] = s
        })
        
        loadSound('high.wav', function(s) {
            BUFFERS['high'] = s
        })
        
        var app = new Vue({
            el: '#app',
            data: {
                high_pitch: false,
                
                practice_status: null,
                practice_interval: null,
                practice_words: [],
                
                countdown: 3,
                countdown_interval: null,
                
                show_answers: false,
                
                started: false
            },
            
            watch: {
                high_pitch: function() {
                    if(app.high_pitch) {
                        Morse.source.buffer = BUFFERS.high
                    } else {
                        Morse.source.buffer = BUFFERS.low
                    }
                }
            },
            
            methods: {
                startApp: function() {
                    app.started = true
                    
                    Morse.play()
                    Morse.changeVolume(0)
                    
                    Vue.nextTick(function() {
                        $('.collapsible').collapsible();
            
                        $('.play').on('click', function () {
                            app.playLetter($(this).text())
                        })
            
                        $('#play-raw').on('click', function () {
                            app.playText($('#raw-text').val())
                        })
                    })
                },
                
                playLetter: function (l, cb) {
                    /*if(app.high_pitch) {
                        var pitch = 'h';
                    } else {
                        var pitch = 'l';
                    }
                    
                    var sound = $('<audio />').attr('src', 'sounds/' + l.toUpperCase() + '7'+ pitch +'.wav')[0];
        
                    sound.play();
        
                    if (cb) $(sound).on('ended', cb)*/
                    
                    var l = l.toUpperCase()
                    playMorse(index[l])
                },
        
                playSequence: function (ls, cb) {
                    /*if (ls.length) {
                        
                        app.playLetter(ls[0], function () {
                            
                            setTimeout(function () {
                                if(ls) {
                                    app.playSequence(ls.splice(1), cb)
                                } else {
                                    if(cb) cb()
                                }
                            }, 1000)
                            
                        })
                    } else {
                        if(cb) cb()
                    }*/
                    
                    playMorse(ls.map(function(c) {
                        c = c.toUpperCase()
                        return index[c]
                    }).join(' '), cb)
                },
        
                playText: function (t, cb) {
                    var i = 0
        
                    var letters = t.split('')
                    app.playSequence(letters, cb)
                },
                
                startPractice: function() {
                    app.practice_status = 'starting'
                    
                    app.countdown_interval = setInterval(function() {
                        app.countdown -= 1
                        
                        if(app.countdown == 0) {
                            clearInterval(app.countdown_interval)
                            
                            app.resumePractice()
                        }
                    }, 1000)
                },
                
                pausePractice: function() {
                    app.practice_status = 'paused'
                },
                
                resumePractice: function() {
                    app.practice_status = 'running'
                    
                    app.nextPracticeWord()
                },
                
                nextPracticeWord: function(cb) {
                    var word = generateSequence(3)
                    
                    app.practice_words.push(word)
                    
                    app.playText(word, function() {
                        if(app.practice_status == 'running') {
                            setTimeout(app.nextPracticeWord, 2800)
                        }
                    })
                }
            }
        })
        
        function generateSequence(l) {
            var text = "";
            var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

            for (var i = 0; i < l; i++)
                text += possible.charAt(Math.floor(Math.random() * possible.length));

            return text;
        }
        
        var index = {
            'A': '.-',
            'B': '-...',
            'C': '-.-.',
            'D': '-..',
            'E': '.',
            'F': '..-.',
            'G': '--.',
            'H': '....',
            'I': '..',
            'J': '.---',
            'K': '-.-',
            'L': '.-..',
            'M': '--',
            'N': '-.',
            'O': '---',
            'P': '.--.',
            'Q': '--.-',
            'R': '.-.',
            'S': '...',
            'T': '-',
            'U': '..-',
            'V': '...-',
            'W': '.--',
            'X': '-..-',
            'Y': '-.--',
            'Z': '--..'
        }
        
        var dot = function(cb) {
            Morse.changeVolume(0)
            Morse.changeVolume(1)
            
            setTimeout(function() {
                Morse.changeVolume(0)
                
                cb()
            }, 150)
        }
        
        var dash = function(cb) {
            Morse.changeVolume(0)
            Morse.changeVolume(1)
            
            setTimeout(function() {
                Morse.changeVolume(0)
                
                cb()
            }, 440)
        }
        
        var playMorse = function(s, cb) {
            if(s.length == 0 && cb) {
                cb()
            } else {
                var c = s[0];
                var rest = s.slice(1)
                
                if(c == '.') {
                    dot(function() {
                        setTimeout(function() {
                            playMorse(rest, cb)
                        }, 120)
                    })
                }
                
                if(c == '-') {
                    dash(function() {
                        setTimeout(function() {
                            playMorse(rest, cb)
                        }, 120)
                    })
                }
                
                if(c == ' ') {
                    setTimeout(function() {
                        playMorse(rest, cb)
                    }, 850)
                }
            }
        }
    </script>
</body>

</html>